.\" Hey Emacs! This file is -*- nroff -*- source.
.\"
.\" Copyright 1993 Rickard E. Faith (faith@cs.unc.edu) and
.\" 2002 Michael Kerrisk
.\"
.\" Permission is granted to make and distribute verbatim copies of this
.\" manual provided the copyright notice and this permission notice are
.\" preserved on all copies.
.\"
.\" Permission is granted to copy and distribute modified versions of this
.\" manual under the conditions for verbatim copying, provided that the
.\" entire resulting derived work is distributed under the terms of a
.\" permission notice identical to this one
.\" 
.\" Since the Linux kernel and libraries are constantly changing, this
.\" manual page may be incorrect or out-of-date.  The author(s) assume no
.\" responsibility for errors or omissions, or for damages resulting from
.\" the use of the information contained herein.  The author(s) may not
.\" have taken the same level of care in the production of this manual,
.\" which is licensed free of charge, as they might when working
.\" professionally.
.\" 
.\" Formatted or processed versions of this manual, if unaccompanied by
.\" the source, must acknowledge the copyright and authors of this work.
.\"
.\" Modified Fri Jan 31 16:26:07 1997 by Eric S. Raymond <esr@thyrsus.com>
.\" Modified Fri Dec 11 17:57:27 1998 by Jamie Lokier <jamie@imbolc.ucc.ie>
.\" Modified 24 Apr 2002 by Michael Kerrisk <mtk16@ext.cannterbury.ac.nz>
.\"    Substantial rewrites and additions
.\"
.\" Translation (c) 1998 Przemek Borys <pborys@dione.ids.pl>
.\" Last update: A. Krzysztofowicz <ankry@mif.pg.gda.pl>, Aug 2002,
.\"              manpages 1.52
.\"
.TH FLOCK 2 2002-04-24 Linux "Podrêcznik programisty Linuksa"
.SH NAZWA
flock \- za³o¿enie lub zdjêcie doradczej blokady na otwartym pliku.
.SH SK£ADNIA
.B #include <sys/file.h>
.sp
.BR "int flock(int " fd ", int " operation );
.SH OPIS
Zak³ada lub zdejmuje doradcz± blokadê na otwartym pliku, okre¶lonym
przez
.IR fd .
Parameter
.I operation
jest jednym z poni¿szych:
.RS
.sp
.TP 1.0i
.B LOCK_SH
Za³o¿enie blokady wspó³dzielonej. Wiêcej ni¿ jeden proces mo¿e j± utrzymywaæ
na danym pliku w danej chwili.
.TP
.B LOCK_EX
Za³o¿enie blokady wy³±cznej. Tylko jeden proces mo¿e j± utrzymywaæ na danym
pliku w danej chwili.
.TP
.B LOCK_UN
Usuniêcie istniej±cej blokady, za³o¿onej przez bie¿±cy proces.
.sp
.RE

Wywo³anie
.BR flock ()
mo¿e siê zblokowaæ, gdy inny proces utrzymuje blokadê niezgodnego typu.
Aby uzyskaæ wywo³anie nieblokuj±ce, nale¿y dodaæ w dowolnej z powy¿szych
warto¶ci operation
.B LOCK_NB
(za pomoc± bitowego
.IR OR ).

Pojedynczy plik nie mo¿e mieæ jednocze¶nie za³o¿onej blokady wspó³dzielonej
i wy³±cznej.

Blokady utworzone za pomoc±
.BR flock ()
s± skojarzone z plikiem, lub dok³adniej, z wpisem w tablicy otwartych plików. 
Oznacza to, ¿e powielone deskryptory plików (utworzone na przy³ad za pomoc±
.BR fork "(2) lub " dup (2))
odnosz± siê do tej samej blokady i ta blokada mo¿e byæ zmieniana lub
zwalnaina za pomoc± dowolnego ze wspomnianych deskryptorów. Ponadto,
blokada zostaje zwolniona albo w wyniku jawnego wykonania operacji
.B LOCK_UN
na dowolnym z tych powielonych deskryptorów, albo po zamkniêciu wszytkich
tych deskryptorów.

Proces mo¿e utrzymywaæ dla pliku tylko jeden rodzaj blokady (wspó³dzielon± lub
wy³±czn±). Pó¼niejsze wywo³ania
.BR flock ()
s± zachowywane poprzez wywo³ania
.BR execve (2).

Blokada wspó³dzielona lub wy³±czna mo¿e zostaæ za³o¿ona na pliku niezale¿nie
od trybu otwarcia tego pliku.
.SH "WARTO¦Æ ZWRACANA"
Po pomy¶lnym zakoñczeniu zwracane jest zero. Po b³êdzie zwracane jest \-1
i odpowiednio ustawiane
.IR errno .
.SH B£ÊDY
.TP
.B EWOULDBLOCK
Plik jest zablokowany, a by³ ustawiony znacznik
.BR LOCK_NB .
.TP
.B EBADF
.I fd
nie jest deskryptorem otwartego pliku.
.TP
.B EINTR
Wywo³anie zosta³o przerwane podczas oczekiwania na za³o¿enie blokady
w wyniku dorêczenia i przechwycenia sygna³u przez procedurê jego obs³ugi.
.TP
.B EINVAL
.I operation
jest niepoprawne.
.TP
.B ENOLCK
Zabrak³o pamiêci dla j±dra na przydzielenie rekordów dla blokad.
.SH "ZGODNE Z"
4.4BSD (funkcja
.BR flock (2)
pojawi³a siê pierwotnie w 4.2BSD).
Pewna wersja 
.BR flock (2),
prawdopodobnie zaimplementowana w oparciu o
.BR fcntl (2),
pojawia siê w wiêkszo¶ci Uniksów.
.SH UWAGI
.BR flock (2)
nie blokuje plików przez NFS. Nale¿y zamiast tego korzystaæ z
.BR fcntl (2):
ta funkcja dzia³a przez NFS, o ile wersja Linuksa jest dostatecznie nowe
i serwer wspiera blokowanie.
.PP
Pocz±wszy od j±dra 2.0,
.BR flock (2)
jest zaimplementowane jako samodzielna funkcja systemowa, zamiast jej
emulacji w bibliotece GNU C za pomoc± wywo³ania
.BR fcntl (2).
Daje to prawdziw± semantykê BSD:
nie ma interakcji pomiêdzy blokadami ró¿nych typów, tworzonymi za pomoc±
.BR flock (2)
oraz tworzonymi za pomoc± 
.BR fcntl (2).
.BR flock (2)
Nie wykrywa zakleszczenia blokad.
.PP
.BR flock (2)
tworzy jedynie blokady doradcze; proces posiadaj±cy odpowiednie uprawnienia
do pliku, mo¿e swobodnie zignorowaæ fakt u¿ycia
.BR flock (2)
i wykonywac operacje we/wy na tym pliku.
.PP
Blokady
.BR flock (2)
i
.BR fcntl (2)
posiadaj± ró¿n± semantykê w odniesieniu do rozga³êzionych procesów oraz
.BR dup (2).
.SH "ZOBACZ TAK¯E"
.BR open (2),
.BR close (2),
.BR dup (2),
.BR execve (2),
.BR fcntl (2),
.BR fork (2).
.BR lockf (3)

Istniej± tak¿e pliki
.I locks.txt
i
.I mandatory.txt
w
.IR /usr/src/linux/Documentation .
